<!DOCTYPE html>
<html>
<head>
    <title>Table Exporter</title>
</head>
<body>
<h1>Table Exporter</h1>
<ul id="tableList"></ul>
<button id="customButton">Custom</button>
<button id="exportButton">Export</button>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        fetch('/api/tables')
            .then(response => response.json())
            .then(data => {
                const tableList = document.getElementById('tableList');
                tableList.innerHTML = '';

                data.forEach(table => {
                    const li = document.createElement('li');
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = table;
                    checkbox.value = table;
                    checkbox.name = 'tables';

                    const label = document.createElement('label');
                    label.htmlFor = table;
                    label.textContent = table;

                    li.appendChild(checkbox);
                    li.appendChild(label);
                    tableList.appendChild(li);
                });
            })
            .catch(error => console.error('Error fetching tables:', error));

        document.getElementById('customButton').addEventListener('click', function() {
            const selectedTables = [];
            document.querySelectorAll('input[name="tables"]:checked').forEach(checkbox => {
                selectedTables.push(checkbox.value);
            });

            if (selectedTables.length > 0) {
                localStorage.setItem('selectedTables', JSON.stringify(selectedTables));
                window.location.href = 'custom.html';
            } else {
                alert('Please select at least one table.');
            }
        });

        document.getElementById('exportButton').addEventListener('click', function() {
            const selectedTables = [];
            document.querySelectorAll('input[name="tables"]:checked').forEach(checkbox => {
                selectedTables.push(checkbox.value);
            });

            if (selectedTables.length > 0) {
                const tableColumns = selectedTables.reduce((obj, table) => {
                    obj[table] = []; // This assumes exporting all columns for selected tables
                    return obj;
                }, {});

                fetch('/api/export', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(tableColumns)
                })
                    .then(response => response.text())
                    .then(taskId => {
                        console.log('Export started. Task ID:', taskId);

                        fetch(`/api/excel/${taskId}`)
                            .then(response => response.blob())
                            .then(blob => {
                                const url = window.URL.createObjectURL(blob);
                                const a = document.createElement('a');
                                a.href = url;
                                a.download = `export-${taskId}.xlsx`;
                                document.body.appendChild(a);
                                a.click();
                                a.remove();
                            })
                            .catch(error => console.error('Error downloading Excel file:', error));
                    })
                    .catch(error => console.error('Error exporting tables:', error));
            } else {
                alert('Please select at least one table.');
            }
        });
    });
</script>
</body>
</html>
